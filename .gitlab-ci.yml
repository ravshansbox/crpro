image: docker

services:
  - docker:23-dind

stages:
  - build

variables:
  IMAGE_API: ${CI_REGISTRY}/${CI_PROJECT_PATH}/${CI_COMMIT_REF_NAME}:api
  IMAGE_UI: ${CI_REGISTRY}/${CI_PROJECT_PATH}/${CI_COMMIT_REF_NAME}:ui

before_script:
  - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}

build_api:
  stage: build
  rules:
    - changes:
        - apps/api/*
  script:
    - cp package-lock.json apps/api
    - docker build -t ${IMAGE_API} apps/api
    - docker push ${IMAGE_API}

build_ui:
  stage: build
  rules:
    - changes:
        - apps/ui/*
  script:
    - cp package-lock.json apps/ui
    - docker build -t ${IMAGE_UI} apps/ui
    - docker push ${IMAGE_UI}
